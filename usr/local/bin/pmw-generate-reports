#!/bin/zsh

##############################################################################
#
# Generate all defined Rivendell reports. See rdadmin->Manage Reports for the
# complete list.
# 
##############################################################################

# Log STDOUT and STDERR of this script and all commands called by this
# script to separate files. Note that these files will not contain
# time-stamped messages, this script uses logger(1) to log messages to
# /var/log/syslog with timestamps.
exec 1> /var/tmp/${0##*/}.out
exec 2> /var/tmp/${0##*/}.err

zmodload zsh/datetime

# Get zsh functions necessary for this script
[[ -f ${ROOT:-/}usr/local/bin/zsh-functions ]] && source ${ROOT:-/}usr/local/bin/zsh-functions

doSQL "SELECT NAME FROM REPORTS" | while read report ; do
    service=$(doSQL "SELECT SERVICE_NAME FROM REPORTS WHERE NAME='${report}'")

    # Ensure the directory path exists for the report
    path=$(doSQL "SELECT EXPORT_PATH FROM REPORTS WHERE NAME='${report}'")
    reportDir=$(strftime "$(echo ${path:h})" ${EPOCHSECONDS})
    [[ -d "${reportDir}" ]] || mkdir -p "${reportDir}"

    if [[ -d "${reportDir}" ]] ; then
	/usr/bin/rdlogmanager -r "${report}" -s "${service}"
    else
	logger --stderr -t ${0##*/} -p local7.err -i "ERROR: Could not create report folder ${reportDir} (${?})."
    fi
done

exit
